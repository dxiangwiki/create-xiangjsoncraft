#!/usr/bin/env node
import fs from 'fs-extra';
import path from 'path';
import { fileURLToPath } from 'url';
import inquirer from 'inquirer';
import chalk from 'chalk';
import ora from 'ora';

// è§£å†³ ESModule __dirname é—®é¢˜
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// æ¡†æ¶æ ¹ç›®å½•
const frameworkRoot = path.resolve(__dirname, '..');
// æ¨¡æ¿ç›®å½•
const templateDir = path.join(frameworkRoot, 'template');

// æ¬¢è¿ä¿¡æ¯
console.log(chalk.blue(`
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  XiangJsonCraft 2.0.1           â”‚
      â”‚  Write JSON, Get a Website      â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
`));

// ç¬¬ä¸€æ­¥ï¼šè·å–é¡¹ç›®åç§°ï¼ˆä»å‘½ä»¤è¡Œå‚æ•°ï¼‰
const args = process.argv.slice(2);
let projectName = args[0] || 'xiangjsoncraft-app';

// ç¬¬äºŒæ­¥ï¼šç¡®è®¤åˆ›å»ºé¡¹ç›®
const confirmAnswers = await inquirer.prompt([
    {
        type: 'confirm',
        name: 'confirmCreate',
        message: `æ˜¯å¦è¦åˆ›å»ºé¡¹ç›®ã€Œ${projectName}ã€ï¼Ÿ`,
        default: true
    }
]);

if (!confirmAnswers.confirmCreate) {
    console.log(chalk.yellow('âœ… é¡¹ç›®åˆ›å»ºå·²å–æ¶ˆ'));
    process.exit(0);
}

// ç¬¬ä¸‰æ­¥ï¼šé€‰æ‹©æ¨¡æ¿ï¼ˆä»…ä¿ç•™åŸºç¡€æ¨¡æ¿ï¼Œç¡®ä¿æ ¸å¿ƒåŠŸèƒ½ï¼‰
const templateAnswers = await inquirer.prompt([
    {
        type: 'list',
        name: 'template',
        message: 'è¯·é€‰æ‹©é¡¹ç›®æ¨¡æ¿ï¼š',
        choices: [
            { name: 'åŸºç¡€æ¨¡æ¿ï¼ˆå¿«é€Ÿä¸Šæ‰‹ï¼‰', value: 'basic' }
        ],
        default: 'basic'
    }
]);

// ç¬¬å››æ­¥ï¼šåˆ›å»ºé¡¹ç›®
const spinner = ora('æ­£åœ¨åˆ›å»ºé¡¹ç›®...').start();
try {
    // é¡¹ç›®ç›®æ ‡ç›®å½•
    const projectDir = path.resolve(process.cwd(), projectName);

    // æ£€æŸ¥ç›®å½•æ˜¯å¦å·²å­˜åœ¨
    if (fs.existsSync(projectDir)) {
        spinner.fail(chalk.red('âŒ é¡¹ç›®ç›®å½•å·²å­˜åœ¨ï¼Œè¯·åˆ é™¤åé‡è¯•'));
        process.exit(1);
    }

    // 1. åˆ›å»ºé¡¹ç›®ç›®å½•
    fs.ensureDirSync(projectDir);

    // 2. ç”Ÿæˆ package.jsonï¼ˆä¿®å¤æœ¬åœ°è·¯å¾„ä¾èµ–é—®é¢˜ï¼‰
    const packageJson = {
        "name": projectName,
        "version": "1.0.0",
        "description": "XiangJsonCraft é¡¹ç›®",
        "type": "module",
        "scripts": {
            "start": "npx serve .",
            "test": "echo \"Error: no test specified\" && exit 1"
        },
        "dependencies": {
            // æŒ‡å‘ npm ä»“åº“ç‰ˆæœ¬ï¼Œè€Œéæœ¬åœ°è·¯å¾„
            "xiangjsoncraft": "^2.0.1"
        },
        "license": "MIT"
    };
    fs.writeJsonSync(path.join(projectDir, 'package.json'), packageJson, { spaces: 2 });

    // 3. ç”Ÿæˆæ ¸å¿ƒæ–‡ä»¶ï¼ˆè§£å†³ç©ºå£³é—®é¢˜ï¼‰
    // 3.1 ç”Ÿæˆ index.htmlï¼ˆæ ¸å¿ƒå…¥å£ï¼‰
    const indexHtml = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${projectName} - XiangJsonCraft 2.0</title>
  <!-- å¼•å…¥æ¡†æ¶æ ¸å¿ƒ -->
  <script src="./node_modules/xiangjsoncraft/dist/xiangjsoncraft.umd.js"></script>
</head>
<body>
  <div id="app"></div>
  <!-- å¼•å…¥é…ç½®æ–‡ä»¶ -->
  <script type="module">
    import config from './config.json' assert { type: 'json' };
    // æ¸²æŸ“ JSON é…ç½®
    window.XiangJsonCraft.render(config, document.getElementById('app'));
  </script>
</body>
</html>`;
    fs.writeFileSync(path.join(projectDir, 'index.html'), indexHtml);

    // 3.2 ç”Ÿæˆ config.jsonï¼ˆæ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼‰
    const configJson = {
        "framework": "XiangJsonCraft 2.0.1",
        "styles": {
            "body": {
                "backgroundColor": "#f0f4f8",
                "minHeight": "100vh",
                "margin": "0",
                "padding": "20px",
                "fontFamily": "Arial, sans-serif"
            },
            "#app": {
                "maxWidth": "1200px",
                "margin": "0 auto"
            },
            ".app-title": {
                "fontSize": "2rem",
                "color": "#2d3748",
                "textAlign": "center",
                "marginBottom": "40px"
            },
            ".app-desc": {
                "fontSize": "1.2rem",
                "color": "#4a5568",
                "textAlign": "center"
            }
        },
        "content": {
            ".app-title": {
                "value": "æ¬¢è¿ä½¿ç”¨ XiangJsonCraft 2.0.1",
                "isHtml": false
            },
            ".app-desc": {
                "value": "é›¶CSSé›¶JSã€çº¯JSONé©±åŠ¨çš„è½»é‡å‰ç«¯æ¡†æ¶",
                "isHtml": false
            }
        }
    };
    fs.writeJsonSync(path.join(projectDir, 'config.json'), configJson, { spaces: 2 });

    // 3.3 ç”Ÿæˆ README.mdï¼ˆä½¿ç”¨è¯´æ˜ï¼‰
    const readmeMd = `# ${projectName}
åŸºäº XiangJsonCraft 2.0.1 çš„é¡¹ç›®

## å¿«é€Ÿå¼€å§‹
1. å®‰è£…ä¾èµ–ï¼š
   npm install

2. å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼š
   npm run start

3. è‡ªå®šä¹‰é¡¹ç›®ï¼š
   ä¿®æ”¹ config.json æ–‡ä»¶ï¼ˆæ‰€æœ‰æ ·å¼/å†…å®¹/äº¤äº’éƒ½åœ¨è¿™é‡Œé…ç½®ï¼‰

## æ ¸å¿ƒç‰¹æ€§
- çº¯ JSON é©±åŠ¨ï¼Œæ— éœ€ç¼–å†™ CSS/JS
- å“åº”å¼å¸ƒå±€ï¼Œé€‚é…æ‰€æœ‰è®¾å¤‡
- å®æ—¶çƒ­æ›´æ–°ï¼Œä¿®æ”¹é…ç½®ç«‹å³ç”Ÿæ•ˆ
- é›¶é…ç½®éƒ¨ç½²ï¼Œç›´æ¥ä¸Šä¼ æ–‡ä»¶å³å¯å‘å¸ƒ
`;
    fs.writeFileSync(path.join(projectDir, 'README.md'), readmeMd);

    spinner.succeed(chalk.green(`âœ… é¡¹ç›®ã€Œ${projectName}ã€åˆ›å»ºæˆåŠŸï¼`));

    // ç¬¬äº”æ­¥ï¼šå®‰è£…ä¾èµ–æç¤º
    const installAnswers = await inquirer.prompt([
        {
            type: 'confirm',
            name: 'confirmInstall',
            message: 'æ˜¯å¦ç«‹å³å®‰è£…é¡¹ç›®ä¾èµ–ï¼Ÿ',
            default: true
        }
    ]);

    if (installAnswers.confirmInstall) {
        const installSpinner = ora('æ­£åœ¨å®‰è£…ä¾èµ–...').start();
        try {
            // åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•æ‰§è¡Œå®‰è£…
            const { execSync } = await import('child_process');
            execSync('npm install --legacy-peer-deps', {
                cwd: projectDir,
                stdio: 'ignore'
            });
            installSpinner.succeed(chalk.green('âœ… ä¾èµ–å®‰è£…æˆåŠŸï¼'));
        } catch (err) {
            installSpinner.fail(chalk.yellow('âš ï¸ ä¾èµ–å®‰è£…å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¿›å…¥é¡¹ç›®ç›®å½•æ‰§è¡Œ npm install --legacy-peer-deps'));
        }
    }

    // è¾“å‡ºä½¿ç”¨æŒ‡å—
    console.log(chalk.cyan(`
 ä½¿ç”¨æŒ‡å—
1. è¿›å…¥é¡¹ç›®ç›®å½•ï¼š
   cd ${projectName}
2. å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼š
   npm run start
3. è‡ªå®šä¹‰é¡¹ç›®ï¼š
   ä¿®æ”¹ config.json æ–‡ä»¶ï¼ˆæ‰€æœ‰æ ·å¼/å†…å®¹/äº¤äº’éƒ½åœ¨è¿™é‡Œé…ç½®ï¼‰
4. éƒ¨ç½²ä¸Šçº¿ï¼š
   ç›´æ¥å°†é¡¹ç›®æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨å³å¯ï¼Œæ— éœ€æ‰“åŒ…

ğŸ“š å®˜æ–¹æ–‡æ¡£ï¼šhttps://github.com/dxiangwiki/xiangjsoncraft
ğŸ’¡ æç¤ºï¼šå¿…é¡»ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨è¿è¡Œï¼Œä¸èƒ½ç›´æ¥æ‰“å¼€HTMLæ–‡ä»¶ï¼
  `));

} catch (err) {
    spinner.fail(chalk.red(`âŒ é¡¹ç›®åˆ›å»ºå¤±è´¥ï¼š${err.message}`));
    process.exit(1);
}