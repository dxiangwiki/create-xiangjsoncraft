'use strict';

// å°è£…é€šç”¨JSONæ ·å¼æ¸²æŸ“å‡½æ•°ï¼Œæ”¯æŒä»»æ„CSSé€‰æ‹©å™¨ã€HTMLå†…å®¹ã€åª’ä½“æŸ¥è¯¢ï¼ˆv1.1.0æ ¸å¿ƒåŠŸèƒ½ï¼‰
function renderJsonStyles() {
    // æ ¸å¿ƒåŸåˆ™ï¼šæœ¬åœ°config.jsonæ°¸è¿œæœ€é«˜ä¼˜å…ˆçº§ï¼ŒåŠ è½½å¤±è´¥å†ç”¨CDNå®˜æ–¹é…ç½®
    const localConfigUrl = './config.json'; // æœ¬åœ°ç”¨æˆ·è‡ªå®šä¹‰é…ç½®
    const cdnConfigUrl = 'https://cdn.jsdelivr.net/npm/xiangjsoncraft@1.1.1/config.json'; // CDNå…œåº•é…ç½®

    // å…ˆå°è¯•åŠ è½½æœ¬åœ°config.json
    fetch(localConfigUrl)
        .then(response => {
            // æœ¬åœ°é…ç½®å­˜åœ¨ï¼ˆçŠ¶æ€ç 200ï¼‰ï¼Œåˆ™ä½¿ç”¨æœ¬åœ°é…ç½®
            if (response.ok) {
                console.log('ğŸ”§ æ£€æµ‹åˆ°æœ¬åœ°config.jsonï¼Œä¼˜å…ˆåŠ è½½ç”¨æˆ·è‡ªå®šä¹‰é…ç½®');
                return response.json();
            }
            // æœ¬åœ°é…ç½®ä¸å­˜åœ¨/åŠ è½½å¤±è´¥ï¼Œåˆ‡æ¢åˆ°CDNå…œåº•é…ç½®
            console.log('â„¹ï¸  æœ¬åœ°æœªæ£€æµ‹åˆ°config.jsonï¼ŒåŠ è½½CDNå®˜æ–¹ç¤ºä¾‹é…ç½®');
            return fetch(cdnConfigUrl).then(res => {
                if (!res.ok) throw new Error('CDNå®˜æ–¹é…ç½®åŠ è½½å¤±è´¥');
                return res.json();
            });
        })
        .then(config => {
            // è·å–æˆ–åˆ›å»ºæ ·å¼å—ï¼Œé¿å…é‡å¤åˆ›å»º
            const styleBlock = document.getElementById('dynamic-styles') || createStyleBlock();
            if (!styleBlock) return console.error('âŒ æ ·å¼å—åˆ›å»ºå¤±è´¥ï¼Œæ— æ³•æ¸²æŸ“æ ·å¼');

            // ç”ŸæˆCSSè§„åˆ™
            let cssRules = '';

            // å¤„ç†æ‰€æœ‰é€‰æ‹©å™¨æ ·å¼ï¼ˆæ”¯æŒä»»æ„CSSé€‰æ‹©å™¨ã€åª’ä½“æŸ¥è¯¢ï¼‰
            if (config.styles && typeof config.styles === 'object' && Object.keys(config.styles).length > 0) {
                // éå†æ‰€æœ‰é€‰æ‹©å™¨ï¼ˆç±»ã€IDã€ä¼ªç±»ã€åª’ä½“æŸ¥è¯¢ç­‰ï¼‰
                Object.entries(config.styles).forEach(([selector, styles]) => {
                    // è¿‡æ»¤ç©ºæ ·å¼ï¼Œé¿å…æ— æ•ˆCSS
                    if (!styles || typeof styles !== 'object') return;
                    // ç”Ÿæˆè¯¥é€‰æ‹©å™¨çš„æ‰€æœ‰æ ·å¼å±æ€§
                    const styleProperties = Object.entries(styles)
                        .map(([prop, value]) => {
                            // è¿‡æ»¤ç©ºå±æ€§ï¼Œé©¼å³°å¼å±æ€§åè½¬æ¢ä¸ºCSSæ ‡å‡†æ ¼å¼
                            if (!prop || value === undefined || value === null) return '';
                            const cssProp = prop.replaceCamelCase();
                            return `${cssProp}: ${value};`;
                        })
                        .filter(Boolean) // ç§»é™¤ç©ºå±æ€§
                        .join('\n    ');

                    // ä»…å½“æœ‰æ ·å¼å±æ€§æ—¶ï¼Œæ·»åŠ åˆ°CSSè§„åˆ™
                    if (styleProperties) {
                        cssRules += `${selector} {\n    ${styleProperties}\n}\n\n`;
                    }
                });
            }

            // åº”ç”¨ç”Ÿæˆçš„CSSè§„åˆ™åˆ°æ ·å¼å—
            if (cssRules) {
                styleBlock.innerHTML = cssRules;
            }

            // å¤„ç†å†…å®¹é…ç½®ï¼ˆæ”¯æŒçº¯æ–‡æœ¬/HTMLå†…å®¹ï¼Œé€šè¿‡isHtmlæ ‡è¯†ï¼‰
            if (config.content && typeof config.content === 'object' && Object.keys(config.content).length > 0) {
                Object.entries(config.content).forEach(([selector, content]) => {
                    // è¿‡æ»¤æ— æ•ˆé€‰æ‹©å™¨å’Œå†…å®¹
                    if (!selector || !content || !content.hasOwnProperty('value')) return;
                    const elements = document.querySelectorAll(selector);
                    elements.forEach(el => {
                        if (!el) return;
                        // æ”¯æŒHTMLå†…å®¹æˆ–çº¯æ–‡æœ¬ï¼Œé»˜è®¤çº¯æ–‡æœ¬
                        if (content.isHtml) {
                            el.innerHTML = content.value;
                        } else {
                            el.textContent = content.value;
                        }
                    });
                });
            }

            console.log('âœ… XiangJsonCraft v1.1.1 æ¸²æŸ“æˆåŠŸï¼');
        })
        .catch(error => {
            console.error('âŒ XiangJsonCraft å¤„ç†é…ç½®æ—¶å‡ºé”™:', error.message);
        });
}

exports.renderJsonStyles = renderJsonStyles;
