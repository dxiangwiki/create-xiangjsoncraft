/**
 * XiangJsonCraft 2.0 核心渲染逻辑
 * 纯JSON驱动的前端框架核心 - Write JSON, Get a Website
 * @version 2.0.0
 */

// 驼峰转短横线（CSS属性名转换）
String.prototype.replaceCamelCase = function (separator = '-') {
    return this.replace(/[A-Z]/g, (match) => `${separator}${match.toLowerCase()}`);
};

// 创建唯一样式块
function createStyleBlock() {
    const style = document.createElement('style');
    style.id = 'xiangjsoncraft-styles';
    document.head.insertBefore(style, document.head.firstChild);
    return style;
}

// 核心渲染函数
export function renderJsonStyles() {
    // 配置文件路径（固定与HTML同目录）
    const CONFIG_PATH = './config.json';

    // 错误处理
    const handleError = (msg) => {
        console.error(chalk?.red(`❌ XiangJsonCraft 2.0 错误: ${msg}`) || `❌ XiangJsonCraft 2.0 错误: ${msg}`);
    };

    // 加载配置并渲染
    fetch(CONFIG_PATH)
        .then(async (res) => {
            if (!res.ok) throw new Error('配置文件加载失败，请检查config.json是否存在');
            return res.json();
        })
        .then((config) => {
            // 配置校验
            if (typeof config !== 'object' || config === null || Array.isArray(config)) {
                return handleError('config.json 格式错误，必须是标准JSON对象');
            }

            // 1. 渲染样式
            const styleBlock = document.getElementById('xiangjsoncraft-styles') || createStyleBlock();
            const { styles = {} } = config;
            let cssRules = '';

            // 生成CSS规则
            Object.entries(styles).forEach(([selector, styleObj]) => {
                const selectorStr = String(selector).trim();
                if (!selectorStr || typeof styleObj !== 'object' || styleObj === null || Array.isArray(styleObj)) return;

                const styleProps = Object.entries(styleObj)
                    .map(([prop, value]) => {
                        const propStr = String(prop).trim();
                        if (!propStr || value === undefined || value === null || String(value).trim() === '') return '';
                        const cssProp = propStr.replaceCamelCase();
                        const cssValue = String(value).trim();
                        return `${cssProp}: ${cssValue};`;
                    })
                    .filter(Boolean)
                    .join('\n    ');

                if (styleProps) {
                    cssRules += `${selectorStr} {\n    ${styleProps}\n}\n\n`;
                }
            });

            // 注入样式
            if (cssRules) {
                styleBlock.innerHTML = cssRules;
            }

            // 2. 渲染内容
            const { content = {} } = config;
            Object.entries(content).forEach(([selector, contentObj]) => {
                const selectorStr = String(selector).trim();
                if (!selectorStr || typeof contentObj !== 'object' || contentObj === null || Array.isArray(contentObj)) return;
                if (!contentObj.hasOwnProperty('value')) return;

                const targetNodes = document.querySelectorAll(selectorStr);
                if (targetNodes.length === 0) return;

                const { value, isHtml = false } = contentObj;
                const contentValue = String(value).trim();

                targetNodes.forEach((node) => {
                    if (isHtml) {
                        node.innerHTML = contentValue;
                    } else {
                        node.textContent = contentValue;
                    }
                });
            });

            // 渲染成功提示
            console.log(chalk?.green('✅ XiangJsonCraft 2.0 渲染成功！') || '✅ XiangJsonCraft 2.0 渲染成功！');
            console.log(chalk?.blue('ℹ️  修改config.json后刷新页面即可生效') || 'ℹ️  修改config.json后刷新页面即可生效');

        })
        .catch((err) => {
            handleError(err.message);
        });
}

// 暴露全局变量（兼容非模块化环境）
if (typeof window !== 'undefined') {
    window.XiangJsonCraft = {
        renderJsonStyles,
        version: '2.0.0'
    };
}